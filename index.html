<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH Pro - Secured Financial System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --cgd: #0056b3; --capital: #8e44ad; --success: #27ae60; --danger: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: #333; overflow-x: hidden; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 320px; text-align: center; }
        .login-box h2 { margin-bottom: 20px; color: var(--primary); }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-login { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        #app-content { display: none; } 

        .nav-tabs { background: var(--primary); display: flex; padding: 0 20px; position: sticky; top: 0; z-index: 100; align-items: center; }
        .tab-btn { background: none; border: none; color: #bdc3c7; padding: 15px 25px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s; border-bottom: 3px solid transparent; font-size: 13px; }
        .tab-btn.active { color: white; border-bottom: 3px solid var(--success); }
        .btn-logout { margin-left: auto; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .top-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin: 0; font-size: 0.7em; color: #7f8c8d; text-transform: uppercase; }
        .card .val { font-size: 1.1em; font-weight: bold; margin-top: 5px; display: block; }
        .box { background: white; padding: 18px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.04); margin-bottom: 20px; border: 1px solid #eee; }
        .box h4 { margin: 0 0 15px 0; font-size: 0.85em; border-bottom: 1px solid #f1f1f1; padding-bottom: 8px; color: var(--primary); text-transform: uppercase; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(105px, 1fr)); gap: 10px; align-items: flex-end; }
        label { display: block; font-size: 10px; font-weight: bold; margin-bottom: 4px; color: #777; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; }
        .btn { padding: 9px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; font-size: 11px; }
        .btn-add { background: var(--success); }
        .btn-del { background: #ff7675; padding: 2px 6px; border-radius: 4px; color:white; cursor:pointer; font-size: 9px; }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #fdfdfd; padding: 10px; text-align: left; font-size: 10px; color: #999; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid #f7f7f7; font-size: 12px; }
        .income-text { color: var(--success); font-weight: bold; }
        .expense-text { color: var(--danger); font-weight: bold; }
        .manage-list { max-height: 180px; overflow-y: auto; border: 1px solid #f1f1f1; padding: 5px; border-radius: 5px; background: #fafafa; }
        .manage-item { display:flex; justify-content:space-between; padding:4px 8px; border-bottom:1px solid #eee; align-items: center; font-size: 10px; }
        .dash-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* ESTILO IMPORTAÇÃO */
        .import-table input, .import-table select { width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ddd; }
        .import-table tr:hover { background: #f0f7ff; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>WH Pro Login</h2>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn-login" id="btn-do-login">Entrar</button>
            <p id="login-error" style="color:red; font-size:12px; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <div id="app-content">
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="tab-entry">Entry & Balances</button>
            <button class="tab-btn" data-tab="tab-import">Import Excel</button>
            <button class="tab-btn" data-tab="tab-history">History</button>
            <button class="tab-btn" data-tab="tab-dashboard">Dashboard</button>
            <button class="btn-logout" id="btn-logout">Sair</button>
        </nav>

        <div class="container">
            <div class="top-summary" id="bank-cards-container"></div>

            <!-- TAB ENTRY -->
            <div id="tab-entry" class="tab-content active">
                <div style="display: grid; grid-template-columns: 2.8fr 1fr; gap: 20px;">
                    <div>
                        <div class="box">
                            <h4>New Transaction</h4>
                            <div class="form-grid">
                                <div><label>Date</label><input type="date" id="ipt-date"></div>
                                <div><label>Doc Number</label><input type="text" id="ipt-doc" placeholder="Invoice #"></div>
                                <div><label>Entity</label><select id="sel-entity"></select></div>
                                <div><label>Method</label><select id="sel-method"><option value="BANK">BANK</option><option value="CASH">CASH</option></select></div>
                                <div><label>Bank Account</label><select id="sel-bank"></select></div>
                                <div><label>Place</label><select id="sel-place-entry"></select></div>
                                <div><label>Type</label><select id="sel-type">
                                    <option value="EXPENSES">EXPENSES</option>
                                    <option value="INCOME">INCOME</option>
                                    <option value="TRANSFER +">TRANSFER +</option>
                                    <option value="TRANSFER -">TRANSFER -</option>
                                </select></div>
                                <div><label>Net Value</label><input type="number" id="ipt-net" step="0.01" value="0"></div>
                                <div><label>VAT</label><input type="number" id="ipt-vat" step="0.01" value="0"></div>
                                <div><label>Total</label><input type="number" id="ipt-total" step="0.01" readonly style="background:#f9f9f9"></div>
                                <button class="btn btn-add" id="btn-register">Register Entry</button>
                            </div>
                        </div>
                        <div class="box">
                            <h4>Recent Activity</h4>
                            <div class="table-container"><table><thead><tr><th>Date</th><th>Doc No.</th><th>Entity</th><th>Bank</th><th>Place</th><th>Type</th><th align="right">Total</th><th>Action</th></tr></thead><tbody id="table-recent"></tbody></table></div>
                        </div>
                    </div>
                    <div>
                        <div class="box" style="border-left: 4px solid var(--capital);">
                            <h4>Initial Balance</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <select id="sel-init-bank"></select>
                                <input type="number" id="ipt-init-val" step="0.01" placeholder="0.00">
                                <button class="btn" id="btn-save-init" style="background: var(--capital);">Set Balance</button>
                            </div>
                        </div>
                        <div class="box"><h4>Entities</h4><div style="display: flex; gap: 5px;"><input type="text" id="ipt-new-entity" placeholder="Name..."><button class="btn btn-add" id="btn-add-entity">+</button></div><div id="list-entities" class="manage-list"></div></div>
                        <div class="box"><h4>Places</h4><div style="display: flex; gap: 5px;"><input type="text" id="ipt-new-place" placeholder="Name..."><button class="btn btn-add" id="btn-add-place">+</button></div><div id="list-places" class="manage-list"></div></div>
                        <div class="box"><h4>Banks</h4><div style="display: flex; gap: 5px;"><input type="text" id="ipt-new-bank" placeholder="Name..."><button class="btn btn-add" id="btn-add-bank">+</button></div><div id="list-banks" class="manage-list"></div></div>
                        <button class="btn" id="btn-restore-defaults" style="background:#999; width:100%; margin-top:10px;">Restore Default Lists</button>
                    </div>
                </div>
            </div>

            <!-- TAB IMPORT EXCEL -->
            <div id="tab-import" class="tab-content">
                <div class="box">
                    <h4>Bulk Import from Excel (Starts Row 2)</h4>
                    <p style="font-size: 11px; color: #666;">Colunas: D=Total, E=Doc#, F=Date, G=Entity, H=Method, I=Bank, J=Place, K=Type.</p>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="file" id="excel-file" accept=".xlsx, .xls">
                        <button class="btn" id="btn-process-excel" style="background: var(--capital);">Mapear Ficheiro</button>
                    </div>
                </div>
                <div class="box" id="import-preview-box" style="display:none;">
                    <h4>Revisão de Importação (<span id="import-count">0</span> movimentos)</h4>
                    <div class="table-container">
                        <table class="import-table">
                            <thead>
                                <tr>
                                    <th>Date (F)</th>
                                    <th>Doc No (E)</th>
                                    <th>Entity (G)</th>
                                    <th>Method (H)</th>
                                    <th>Bank (I)</th>
                                    <th>Place (J)</th>
                                    <th>Type (K)</th>
                                    <th>Total (D)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-import-body"></tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn" id="btn-save-bulk" style="background: var(--success); padding: 15px 30px;">CONFIRMAR E REGISTAR TUDO</button>
                    </div>
                </div>
            </div>

            <!-- TAB HISTORY -->
            <div id="tab-history" class="tab-content">
                <div class="box">
                    <div class="form-grid">
                        <div><label>Year</label><select id="hist-f-year"></select></div>
                        <div><label>Month</label><select id="hist-f-month"></select></div>
                        <div><label>Bank</label><select id="hist-f-bank"></select></div>
                        <div><label>Place</label><select id="hist-f-place"></select></div>
                        <button class="btn" id="btn-export" style="background:var(--success)">Export CSV</button>
                    </div>
                </div>
                <div class="table-container box"><table><thead><tr><th>Date</th><th>Doc No.</th><th>Entity</th><th>Method</th><th>Bank</th><th>Place</th><th>Type</th><th>Net</th><th>VAT</th><th>Total</th><th>Action</th></tr></thead><tbody id="table-history-body"></tbody></table></div>
            </div>

            <!-- TAB DASHBOARD -->
            <div id="tab-dashboard" class="tab-content">
                <div class="box"><div class="form-grid"><div><label>Year</label><select id="dash-f-year"></select></div><div><label>Month</label><select id="dash-f-month"></select></div><div><label>Place</label><select id="dash-f-place"></select></div></div></div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center; margin-bottom: 20px;">
                    <div class="box"><h3>INCOME</h3><b id="dash-num-inc" class="income-text">0.00 €</b></div>
                    <div class="box"><h3>EXPENSES</h3><b id="dash-num-exp" class="expense-text">0.00 €</b></div>
                    <div class="box"><h3>NET RESULT</h3><b id="dash-num-net">0.00 €</b></div>
                </div>
                <div class="dash-grid">
                    <div class="box" style="grid-column: span 2;"><h4>Monthly Trends</h4><div class="chart-container"><canvas id="barChart"></canvas></div></div>
                    <div class="box"><h4>Top Entities Spending</h4><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
                    <div class="box"><h4>Spending by Place</h4><div class="chart-container"><canvas id="placeChart"></canvas></div></div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyANUsqIFOdBMyOBbzs1AZCpWOygkn27dIw",
        authDomain: "financial-system-alcance.firebaseapp.com",
        projectId: "financial-system-alcance",
        storageBucket: "financial-system-alcance.firebasestorage.app",
        messagingSenderId: "1062984544094",
        appId: "1:1062984544094:web:3c165c7b8d9a61c21ae9cf"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const SEED_ENTITIES = ["DPD","MRW","MEO SA","ALVES BANDEIRA","SALARY","INTERMARCHE","NET EMPREGOS","CTT","PAACK","VODAFONE","EDP","ÁGUAS DE COIMBRA","ZURICH SEGUROS","LEROY MERLIN","MODELO","WORTEN","SODICENTRO","PORTAGENS","STAPLES","MAKRO","TOPAZIO RENT","OFFICE RENT","WAREHOUSE RENT","AMAZON","VOIP","PROSEGUR","FIDELIDADE SEGUROS","CULLIGAN","COMMISSION","STUDIO 99","TRIFIDA","KONTABILE","PICAPONTO","ENDESA","CENTROFAX","FUNDACJA FIRMA DLA KASDEGO","BRISA","SWITL","SMARTEC","AMIGO","PARTNER DEVIDENS","SOCIAL SECURITY","FINANCES","LETS CALL","MICROSOFT","SOTECNISOL","SPANISH SIM CARDS","CONTINENTE","AUCHAN","LAWYER","ALDI","AAC","COMPANY VAN","ACCOUNY MANTAINANCE","VIA VERDE","GOOGLE","PASCOAL","WPS","TPLINK","VIDESP","INTERPREV","IKEA","TEAMS","CASA BAIA","BXO VALOR TRANSACO","MANUTAN","ALBERTO CAETANO","RIA SEGUROS","GRUPEME","IBERIA CONSULTANCY LDA","M. MEILAK & ASSOCIATES","COIMPACK","CEPSA","HEALTH PRIME UNLIMITED","PC COMPONENTES","BP","ACTION","RADIO POPULAR","GENERALYS SEGUROS","MVM","CARTUCHO","JYSK","TROVISCAIS","PC DIGA","GRENKE RENTING","UBER","MGM","EUROGRIP","100 METROS","EUPAGO","STAPLES","GALP","PAPIRO LDA","LUSITANIA SEGUROS","NACEX","COMPANY CAR","REFUNDS","SMARTMEDIA","MIXTRONICA","SUPERMESURA","MACOBEGO","BRICOMARCHE","LIDL","IBEROCAR","MEU SUPER","CONTROLAUTO","CLEANING CAR","HIPER EIRAS","REPSOL","NORAUTO","PINGO DOCE","SALTIGLOBO","VAT REFUND","MOVIFLOR","TROPEGAL","VOLL","TRANSFER BETWEEN ACCOUNTS","DISTINTOS DESTINOS","CARDOSO E SOUSA LDA","VIDAXL","TRANSFERENCIA INICIAL","PETROL","CASA YES","MILANNA","PRINK","HOMA","VITALIJUZ JANKUNAS","INDIANO","MULTIMAX","TANMAY NASKAR","ERVINS VANAG","BONUS","ZUMUB","NOTINO","MAKEUP","PEPCO","YULIA YANKUNENE","HONORATA JOZWIK","AIVARS LAKOTKO","ZENUP MARKETING LLC","DAIVA AGLINSKIENE","FLUX LEADS LLC","BONANNO ROSARIO DARIO","VYTAUTAS BIE","ANTANAS KLIMCIAUSKAS","ARTURAS PONOMARIOVAS","RASA UTYRIENE","INESE LEISANE","MINGAILE ARMINAITE","VALENTINA ANTONIUK","CHINES SHOP","RINOADS","TIP","WAN DI","DADDY'S LINE LLC","HERTZ CAR RENTING","QUADROS DELUX","RETURN","CARLOS MARQUES","DAN CAKE","WHITELIST PRO","REMIGIJUS JARMALA","J GOMES","ROMANS SVIRBUTOVICS","FIND PRODUCTS","OTHER","CGD","NOVO BANCO","WELLS","SMART CLIENTS","FNAC","NERINGA ZIDZIUNAITE","INGA BANZINIENE","FZ STARTUP CONSULTANCY LTD","PUSOMA ROZA"];
    const SEED_BANKS = ["NOVO BANCO","MAIN CGD","COD CGD","AGATA CGD","CAPITAL FUND MAIN","WH MAIN CGD","OFF MAIN CGD","TOPA MAIN CGD","CAPITAL FUND OFF","CAPITAL FUND WH","AGATA BPI"];
    const SEED_PLACES = ["OTHER","WAREHOUSE","OFFICE","TOPAZIO","COD","COURIER","POLAND","REFUND","DEW","OFF/WH","CROSSALE","CLIENT","PETROL","NC","COMMISSION","BANK"];

    let state = { banks: SEED_BANKS, entities: SEED_ENTITIES, places: SEED_PLACES, transactions: [], initialBalances: {} };
    let charts = {};
    let unsubtrans, unsublists, unsubinit;

    // AUTH
    document.getElementById('btn-do-login').onclick = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        try { await signInWithEmailAndPassword(auth, email, pass); } 
        catch (e) { document.getElementById('login-error').innerText = "Erro: " + e.message; document.getElementById('login-error').style.display = 'block'; }
    };
    document.getElementById('btn-logout').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            setupSync();
            initUI();
            initCharts();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
        }
    });

    function initUI() {
        document.getElementById('ipt-date').valueAsDate = new Date();
        ['hist', 'dash'].forEach(p => {
            const fy = document.getElementById(p + '-f-year');
            const fm = document.getElementById(p + '-f-month');
            fy.innerHTML = '<option value="All">All Years</option>';
            fm.innerHTML = '<option value="All">All Months</option>';
            for(let y=2024; y<=2030; y++) fy.innerHTML += `<option value="${y}">${y}</option>`;
            MONTHS.forEach(m => fm.innerHTML += `<option value="${m}">${m}</option>`);
            fy.onchange = fm.onchange = () => (p === 'dash' ? refreshDashboard() : render());
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                if(btn.dataset.tab === 'tab-dashboard') refreshDashboard();
            };
        });
    }

    async function setupSync() {
        onSnapshot(collection(db, "transactions"), (snap) => {
            const rawData = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            state.transactions = rawData.sort((a, b) => {
                const tA = a.createdAt ? a.createdAt.toMillis() : new Date(a.date).getTime();
                const tB = b.createdAt ? b.createdAt.toMillis() : new Date(b.date).getTime();
                return tB - tA;
            });
            render();
        });
        onSnapshot(doc(db, "settings", "lists"), (docSnap) => {
            if(docSnap.exists()){
                const d = docSnap.data();
                state.entities = d.entities || SEED_ENTITIES;
                state.banks = d.banks || SEED_BANKS;
                state.places = d.places || SEED_PLACES;
            }
            render();
        });
        onSnapshot(doc(db, "settings", "initialBalances"), (docSnap) => {
            state.initialBalances = docSnap.exists() ? docSnap.data() : {};
            render();
        });
    }

    function render() {
        const hBody = document.getElementById('table-history-body');
        const rBody = document.getElementById('table-recent');
        const bList = document.getElementById('list-banks');
        const eList = document.getElementById('list-entities');
        const pList = document.getElementById('list-places');
        const selEnt = document.getElementById('sel-entity');
        const selBnk = document.getElementById('sel-bank');
        const selPlaE = document.getElementById('sel-place-entry');
        const selInitB = document.getElementById('sel-init-bank');
        const filtBnk = document.getElementById('hist-f-bank');
        const filtPlaH = document.getElementById('hist-f-place');
        const filtPlaD = document.getElementById('dash-f-place');

        const curE = selEnt.value; const curB = selBnk.value; const curP = selPlaE.value;
        hBody.innerHTML = rBody.innerHTML = bList.innerHTML = eList.innerHTML = pList.innerHTML = "";
        selEnt.innerHTML = ""; selBnk.innerHTML = ""; selInitB.innerHTML = ""; selPlaE.innerHTML = "";
        filtBnk.innerHTML = '<option value="All">All Banks</option>';
        filtPlaH.innerHTML = filtPlaD.innerHTML = '<option value="All">All Places</option>';

        state.entities.sort().forEach(e => {
            selEnt.innerHTML += `<option value="${e}">${e}</option>`;
            eList.innerHTML += `<div class="manage-item"><span>${e}</span><button class="btn-del" data-type="entities" data-val="${e}">x</button></div>`;
        });
        selEnt.value = curE;

        state.places.sort().forEach(p => {
            selPlaE.innerHTML += `<option value="${p}">${p}</option>`;
            filtPlaH.innerHTML += `<option value="${p}">${p}</option>`;
            filtPlaD.innerHTML += `<option value="${p}">${p}</option>`;
            pList.innerHTML += `<div class="manage-item"><span>${p}</span><button class="btn-del" data-type="places" data-val="${p}">x</button></div>`;
        });
        selPlaE.value = curP;

        state.banks.sort().forEach(b => {
            selBnk.innerHTML += `<option value="${b}">${b}</option>`;
            selInitB.innerHTML += `<option value="${b}">${b}</option>`;
            filtBnk.innerHTML += `<option value="${b}">${b}</option>`;
            bList.innerHTML += `<div class="manage-item"><span>${b}</span><button class="btn-del" data-type="banks" data-val="${b}">x</button></div>`;
        });
        selBnk.value = curB;

        const balances = {};
        state.banks.forEach(b => balances[b] = state.initialBalances[b] || 0);

        state.transactions.forEach((t, idx) => {
            const isInc = (t.type.includes("INCOME") || t.type.includes("+"));
            const val = isInc ? t.total : -t.total;
            if(balances[t.bank] !== undefined) balances[t.bank] += val;
            if(idx < 8) {
                rBody.innerHTML += `<tr><td>${t.date}</td><td>${t.docNo || '-'}</td><td>${t.entity}</td><td>${t.bank}</td><td>${t.place}</td><td>${t.type}</td><td class="${isInc?'income-text':'expense-text'}" align="right">${t.total.toFixed(2)}€</td><td><button class="btn-del-trans btn" data-id="${t.id}" style="background:#ff7675; padding:2px 5px;">Del</button></td></tr>`;
            }
        });

        const historySorted = [...state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
        const fY = document.getElementById('hist-f-year').value;
        const fM = document.getElementById('hist-f-month').value;
        const fB = document.getElementById('hist-f-bank').value;
        const fP = document.getElementById('hist-f-place').value;

        historySorted.forEach((t) => {
            const isInc = (t.type.includes("INCOME") || t.type.includes("+"));
            const d = new Date(t.date); const tY = d.getFullYear().toString(); const tM = MONTHS[d.getMonth()];
            if((fY==="All" || tY===fY) && (fM==="All" || tM===fM) && (fB==="All" || t.bank===fB) && (fP==="All" || t.place===fP)) {
                hBody.innerHTML += `<tr><td>${t.date}</td><td>${t.docNo || '-'}</td><td>${t.entity}</td><td>${t.method}</td><td>${t.bank}</td><td>${t.place}</td><td>${t.type}</td><td>${(t.net||0).toFixed(2)}</td><td>${(t.vat||0).toFixed(2)}</td><td class="${isInc?'income-text':'expense-text'}">${t.total.toFixed(2)}€</td><td><button class="btn-del-trans btn" data-id="${t.id}" style="background:#ff7675; padding:2px 5px;">Del</button></td></tr>`;
            }
        });

        const cardCont = document.getElementById('bank-cards-container');
        cardCont.innerHTML = ""; let grand = 0;
        Object.keys(balances).sort().forEach(k => {
            grand += balances[k];
            cardCont.innerHTML += `<div class="card"><h3>${k}</h3><span class="val">${balances[k].toLocaleString('pt-PT', {style:'currency', currency:'EUR'})}</span></div>`;
        });
        cardCont.innerHTML += `<div class="card" style="background:var(--primary); color:white"><h3>CONSOLIDATED</h3><span class="val">${grand.toLocaleString('pt-PT', {style:'currency', currency:'EUR'})}</span></div>`;
        
        document.querySelectorAll('.btn-del').forEach(b => b.onclick = (e) => deleteFromList(e.target.closest('button').dataset.type, e.target.closest('button').dataset.val));
        document.querySelectorAll('.btn-del-trans').forEach(b => b.onclick = (e) => deleteTransaction(e.target.closest('button').dataset.id));
        refreshDashboard();
    }

    // REGISTRO MANUAL
    document.getElementById('ipt-net').oninput = document.getElementById('ipt-vat').oninput = () => {
        const n = parseFloat(document.getElementById('ipt-net').value) || 0;
        const v = parseFloat(document.getElementById('ipt-vat').value) || 0;
        document.getElementById('ipt-total').value = (n + v).toFixed(2);
    };

    document.getElementById('btn-register').onclick = async () => {
        const total = parseFloat(document.getElementById('ipt-total').value);
        const date = document.getElementById('ipt-date').value;
        if(!total || !date) return alert("Select date and value");
        await addDoc(collection(db, "transactions"), {
            date, docNo: document.getElementById('ipt-doc').value,
            entity: document.getElementById('sel-entity').value, method: document.getElementById('sel-method').value,
            bank: document.getElementById('sel-bank').value, place: document.getElementById('sel-place-entry').value,
            type: document.getElementById('sel-type').value, net: parseFloat(document.getElementById('ipt-net').value) || 0,
            vat: parseFloat(document.getElementById('ipt-vat').value) || 0, total, createdAt: serverTimestamp()
        });
        document.getElementById('ipt-doc').value = ""; document.getElementById('ipt-net').value = 0;
    };

    // --- AUXILIARY EXCEL HELPERS ---
    function excelDateToJS(serial) {
        if(!serial || isNaN(serial)) return new Date().toISOString().split('T')[0];
        const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
        return date.toISOString().split('T')[0];
    }

    function createOptions(list, selectedVal) {
        return list.map(item => {
            const isSel = String(item).toUpperCase() === String(selectedVal).toUpperCase() ? 'selected' : '';
            return `<option value="${item}" ${isSel}>${item}</option>`;
        }).join('');
    }

    // --- EXCEL PROCESSING ---
    document.getElementById('btn-process-excel').onclick = () => {
        const file = document.getElementById('excel-file').files[0];
        if(!file) return alert("Selecione o ficheiro");

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});

            const previewBody = document.getElementById('table-import-body');
            previewBody.innerHTML = "";
            let count = 0;

            rows.forEach((row, index) => {
                // SKIP HEADER (Starts from Row 2, index 1)
                if (index === 0) return;

                // Validation: Coluna D (Índice 3) deve ter valor
                const valRaw = row[3];
                if (valRaw === undefined || valRaw === "" || isNaN(parseFloat(valRaw))) return;

                const totalVal = parseFloat(valRaw);
                const docNo    = row[4] || ""; // E
                const dateRaw  = row[5];       // F
                const entity   = row[6] || ""; // G
                const method   = row[7] || "BANK"; // H
                const bank     = row[8] || ""; // I
                const place    = row[9] || ""; // J
                const type     = row[10] || "EXPENSES"; // K

                const dateVal = (typeof dateRaw === 'number') ? excelDateToJS(dateRaw) : dateRaw || new Date().toISOString().split('T')[0];

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="date" class="imp-date" value="${dateVal}"></td>
                    <td><input type="text" class="imp-doc" value="${docNo}"></td>
                    <td><select class="imp-ent">${createOptions(state.entities, entity)}</select></td>
                    <td><select class="imp-meth"><option value="BANK" ${method==="BANK"?'selected':''}>BANK</option><option value="CASH" ${method==="CASH"?'selected':''}>CASH</option></select></td>
                    <td><select class="imp-bank">${createOptions(state.banks, bank)}</select></td>
                    <td><select class="imp-place">${createOptions(state.places, place)}</select></td>
                    <td><select class="imp-type">
                        <option value="EXPENSES" ${type==="EXPENSES"?'selected':''}>EXPENSES</option>
                        <option value="INCOME" ${type==="INCOME"?'selected':''}>INCOME</option>
                        <option value="TRANSFER +" ${type==="TRANSFER +"?'selected':''}>TRANSFER +</option>
                        <option value="TRANSFER -" ${type==="TRANSFER -"?'selected':''}>TRANSFER -</option>
                    </select></td>
                    <td><input type="number" step="0.01" class="imp-total" value="${totalVal.toFixed(2)}"></td>
                    <td><button class="btn btn-del" onclick="this.closest('tr').remove()">X</button></td>
                `;
                previewBody.appendChild(tr);
                count++;
            });

            if(count > 0) {
                document.getElementById('import-preview-box').style.display = "block";
                document.getElementById('import-count').innerText = count;
            } else {
                alert("Nenhuma linha de dados (após o cabeçalho) foi encontrada.");
            }
        };
        reader.readAsArrayBuffer(file);
    };

    document.getElementById('btn-save-bulk').onclick = async () => {
        const rows = document.querySelectorAll('#table-import-body tr');
        if(!confirm(`Importar ${rows.length} movimentos?`)) return;

        const btn = document.getElementById('btn-save-bulk');
        btn.disabled = true; btn.innerText = "A guardar...";

        try {
            for (const row of rows) {
                const data = {
                    date: row.querySelector('.imp-date').value,
                    docNo: row.querySelector('.imp-doc').value,
                    entity: row.querySelector('.imp-ent').value,
                    method: row.querySelector('.imp-meth').value,
                    bank: row.querySelector('.imp-bank').value,
                    place: row.querySelector('.imp-place').value,
                    type: row.querySelector('.imp-type').value,
                    total: parseFloat(row.querySelector('.imp-total').value),
                    net: parseFloat(row.querySelector('.imp-total').value),
                    vat: 0,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, "transactions"), data);
            }
            alert("Importação concluída!");
            document.getElementById('import-preview-box').style.display = "none";
        } catch (e) { alert("Erro: " + e.message); }
        finally { btn.disabled = false; btn.innerText = "CONFIRMAR E REGISTAR TUDO"; }
    };

    // LIST FUNCTIONS
    async function deleteTransaction(id) { if(confirm("Apagar?")) await deleteDoc(doc(db, "transactions", id)); }
    document.getElementById('btn-add-entity').onclick = () => addToList('entities', 'ipt-new-entity');
    document.getElementById('btn-add-bank').onclick = () => addToList('banks', 'ipt-new-bank');
    document.getElementById('btn-add-place').onclick = () => addToList('places', 'ipt-new-place');
    document.getElementById('btn-restore-defaults').onclick = async () => { if(confirm("Restaurar?")) await setDoc(doc(db, "settings", "lists"), { entities: SEED_ENTITIES, banks: SEED_BANKS, places: SEED_PLACES }); };

    async function addToList(type, id) {
        const val = document.getElementById(id).value.toUpperCase().trim();
        if(!val || state[type].includes(val)) return;
        const newList = [...state[type], val];
        await updateDoc(doc(db, "settings", "lists"), { [type]: newList });
        document.getElementById(id).value = "";
    }

    async function deleteFromList(type, val) {
        if(!confirm("Remover " + val + "?")) return;
        const newList = state[type].filter(i => i !== val);
        await updateDoc(doc(db, "settings", "lists"), { [type]: newList });
    }

    document.getElementById('btn-save-init').onclick = async () => {
        const b = document.getElementById('sel-init-bank').value;
        const val = parseFloat(document.getElementById('ipt-init-val').value) || 0;
        await setDoc(doc(db, "settings", "initialBalances"), { ...state.initialBalances, [b]: val });
        alert("Guardado.");
    };

    function initCharts() {
        charts.bar = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: MONTHS, datasets: [{label:'Income', backgroundColor:'#27ae60', data:[]}, {label:'Expenses', backgroundColor:'#e74c3c', data:[]}] }, options: { responsive: true, maintainAspectRatio: false } });
        charts.pie = new Chart(document.getElementById('pieChart'), { type: 'doughnut', data: { labels: [], datasets: [{data:[], backgroundColor:['#3498db','#9b59b6','#f1c40f','#e67e22','#1abc9c']}] }, options: { responsive: true, maintainAspectRatio: false } });
        charts.place = new Chart(document.getElementById('placeChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Expenditure', data: [], backgroundColor: '#8e44ad' }]}, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false } });
    }

    function refreshDashboard() {
        if(!charts.bar) return;
        const fY = document.getElementById('dash-f-year').value;
        const fM = document.getElementById('dash-f-month').value;
        const fP = document.getElementById('dash-f-place').value;
        let tI = 0, tE = 0; const entM = {}; const plaM = {};
        const monthly = {}; MONTHS.forEach(m => monthly[m] = { inc: 0, exp: 0 });
        state.transactions.forEach(t => {
            const d = new Date(t.date); const tY = d.getFullYear().toString(); const tM = MONTHS[d.getMonth()];
            const match = (fY === "All" || tY === fY) && (fM === "All" || tM === fM) && (fP === "All" || t.place === fP);
            if(match) { 
                if(t.type.includes("INCOME") || t.type.includes("+")) tI += t.total; 
                else { tE += t.total; entM[t.entity] = (entM[t.entity] || 0) + t.total; plaM[t.place] = (plaM[t.place] || 0) + t.total; } 
            }
            if((fY === "All" || tY === fY) && (fP === "All" || t.place === fP)) {
                if(t.type.includes("INCOME") || t.type.includes("+")) monthly[tM].inc += t.total; else monthly[tM].exp += t.total;
            }
        });
        document.getElementById('dash-num-inc').innerText = tI.toLocaleString('pt-PT') + " €";
        document.getElementById('dash-num-exp').innerText = tE.toLocaleString('pt-PT') + " €";
        document.getElementById('dash-num-net').innerText = (tI - tE).toLocaleString('pt-PT') + " €";
        charts.bar.data.datasets[0].data = MONTHS.map(m => monthly[m].inc); charts.bar.data.datasets[1].data = MONTHS.map(m => monthly[m].exp); charts.bar.update();
        const topE = Object.entries(entM).sort((a,b) => b[1]-a[1]).slice(0,5); charts.pie.data.labels = topE.map(e => e[0]); charts.pie.data.datasets[0].data = topE.map(e => e[1]); charts.pie.update();
        const topP = Object.entries(plaM).sort((a,b) => b[1]-a[1]); charts.place.data.labels = topP.map(p => p[0]); charts.place.data.datasets[0].data = topP.map(p => p[1]); charts.place.update();
    }

    document.getElementById('btn-export').onclick = () => {
        let csv = "\ufeffDate;Doc No;Entity;Method;Bank;Place;Type;Net;VAT;Total\n";
        state.transactions.forEach(t => csv += `${t.date};${t.docNo || ""};${t.entity};${t.method};${t.bank};${t.place};${t.type};${t.net};${t.vat};${t.total}\n`);
        const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "Report.csv"; link.click();
    };
</script>
</body>
</html>
